;; Provides descriptions of what should be exposed to the
;; PostgreSQL/C side.
(library
 (name pgo_fdw_desc)
 (modules pgo_fdw_desc)
 (libraries pgo_typ ctypes))

;; A high-level interface to define PostgreSQL/FDW
(library
  (name pgo_fdw)
  (libraries pgo_api pgo_fdw_desc)
  (modules pgo_fdw)
  )

;; An example FDW defined with pgo_fdw
(library
  (name pgo_fdw_example)
  (libraries pgo_fdw)
  (modules pgo_fdw_example)
  )

;; This exposes pgo_fdw_example to the PostgreSQL/C side.
;; TODO: figure out how to generate this automatically for any FDW out there.
(executable
 (name pgo_fdw_driver)
 (libraries ctypes pgo_fdw_example)
 (modules pgo_fdw_driver internal)
 (foreign_stubs
   (language c)
   (names pgo_fdw_driver internal)
   (flags :standard
          (:include ../config/cflags.sexp)
          "-I."
          ))
 (flags :standard -linkall)
 (modes (native shared_object)))

;; Parts of pgo_fdw_driver are generated by cstubs generation process.
(rule
  (targets internal.c internal.h internal.ml)
  (action (run ./pgo_fdw_gen.exe .)))

(executable 
 (name pgo_fdw_gen)
 (modules pgo_fdw_gen)
 (libraries pgo_fdw_desc ctypes ctypes.stubs))

(install
 (section lib)
 (files
   (pgo_fdw_driver.so as pgo_fdw.so)
   pgo_fdw.sql
   ))
